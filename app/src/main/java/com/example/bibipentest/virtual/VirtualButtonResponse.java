package com.example.bibipentest.virtual;

import android.os.Handler;
import android.util.Log;
import android.util.Pair;
import android.view.View;
import android.widget.Toast;

import com.example.bibipentest.MyApp;
import com.example.bibipentest.R;
import com.example.bibipentest.json.ResponseObject;
import com.example.bibipentest.json.StrokeSubmit;
import com.example.bibipentest.json.SubmitResponse;
import com.example.bibipentest.media.AudioPlayerManager;
import com.example.bibipentest.util.HttpUtil;
import com.example.bibipentest.view.DrawingView;
import com.google.gson.Gson;

import java.io.IOException;
import java.util.Random;

import okhttp3.FormBody;
import okhttp3.MediaType;
import okhttp3.RequestBody;
import okhttp3.Response;

// 响应事件按钮，对应”查答案“
public class VirtualButtonResponse extends VirtualButton {

    private AudioPlayerManager player;

    private Handler uiHandler = new Handler();


    public VirtualButtonResponse(VirtualPoint centerPoint) {
        super(centerPoint.getId(), centerPoint.getX(), centerPoint.getY());
    }

    @Override
    public void triggerClick() {
        String url = "http://10.110.147.81:8088/penUser/getcheckonechar";

        HttpUtil httpUtil = HttpUtil.getInstance();
        SubmitResponse submitResponse = new SubmitResponse(id,MyApp.getInstance().getPhone(),
                MyApp.getInstance().getPaperid());

        Gson gson = new Gson();

        RequestBody requestBody = RequestBody.create(
                MediaType.parse("application/json"),
                gson.toJson(submitResponse)
        );
        httpUtil.postRequest(url, requestBody, new HttpUtil.OkHttpCallback() {
            @Override
            public void onResponse(String response) {
                Log.e("HTTPTEST", "onResponse");
                Gson gson = new Gson();
                ResponseObject responseObject = gson.fromJson(response, ResponseObject.class);
                String toastMessage = responseObject.getMsg();
                uiHandler.post(new Runnable() {
                    @Override
                    public void run() {
                        Toast.makeText(MyApp.getInstance(), toastMessage, Toast.LENGTH_SHORT).show();
                        if (responseObject.getMsg().equals("错误")){
                            player.playAudio(R.raw.wrong_answer);
                        } else if (responseObject.getMsg().equals("正确")){
                            player.playAudio(R.raw.correct_answer);
                        } else if (responseObject.getMsg().startsWith("还未判卷")) {
                            player.playAudio(R.raw.not_judged);
                        } else if (responseObject.getMsg().equals("不存在")){
                            player.playAudio(R.raw.not_submtted);
                        }
                    }
                });

            }

            @Override
            public void onFailure(IOException e) {
                Log.e("HTTPTEST", "onFailure");
                Log.e("HTTPTEST", e.toString());
            }
        });


//        int min = 1;
//        int max = 4;
//        Random random = new Random();
//        int random_state = random.nextInt(max - min + 1) + min;
//        player = AudioPlayerManager.getInstance(MyApp.getInstance());
//        switch (random_state) {
//            case 1:
//                player.playAudio(R.raw.correct_answer);
//                break;
//            case 2:
//                player.playAudio(R.raw.not_judged);
//                break;
//            case 3:
//                player.playAudio(R.raw.not_submtted);
//                break;
//            case 4:
//                player.playAudio(R.raw.wrong_answer);
//                break;
//
//        }

    }

    private static String TAG = "EventTriggerReceiver";

    @Override
    public void testMethod(View view) {
        DrawingView drawingView = (DrawingView) view;
        drawingView.notifyTextChanged("点击响应按钮"+id+"!");
    }
}
