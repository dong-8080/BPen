package com.example.bibipentest.virtual;

import static com.example.bibipentest.virtual.VirtualButtonSubmit.scalingFactor;

import android.util.Log;
import android.view.View;

import com.bbb.bpen.model.PointData;
import com.example.bibipentest.data.PointManager;
import com.example.bibipentest.view.DrawingView;
import com.google.gson.Gson;

import java.util.ArrayList;
import java.util.List;

public class VirtualButtonSubmit extends VirtualButton {

    public static float scalingFactor = 11.810055f;
    // 对应的方格
    public VirtualGrid virtualGrid;

    public VirtualButtonSubmit(VirtualPoint centerPoint){
        super(centerPoint.getId(), centerPoint.getX(), centerPoint.getY());

    }
    // 中心坐标x y
//    public VirtualButtonSubmit(int center_x, int center_y) {
//        super(center_x, center_y);
//        this.virtualGrid = null;
//    }
//
//    public VirtualButtonSubmit(int center_x, int center_y, VirtualGrid vritualGrid) {
//        super(center_x, center_y);
//        this.virtualGrid = vritualGrid;
//    }

    public VirtualGrid getVirtualGrid() {
        return virtualGrid;
    }

    public void bindVritualGrid(VirtualGrid vritualGrid) {
        this.virtualGrid = vritualGrid;
    }

    // 获取田字格绑定的笔迹，深拷贝一下
    public List<PointData> getBindingStrokes(){
        List<PointData> strokes = new ArrayList<>();
        Log.e(TAG, this.virtualGrid.getRelatedPoints().size()+ "   reDrawPointList");
        for (PointData pointData: this.virtualGrid.getRelatedPoints()) {
            strokes.add(
                    new PointData(pointData.getPaper_type(), pointData.getPage_id(), pointData.get_x(),
                            pointData.get_y(), pointData.getlinewidth(), pointData.isStroke_start(),
                            pointData.getTime_stamp(), pointData.isStroke_end(),  pointData.isIsvirtual())
            );
        }
        return strokes;
    }

    // grid对象要绑定笔迹，即从未提交的笔迹中得到相关的所有笔迹
    @Override
    public void triggerClick() {
        // 模拟提交时，可以通知dw画其他颜色的画
        List<PointData> pointScreenList = PointManager.getInstance().getPointScreenList();
        this.virtualGrid.bindStrokes(pointScreenList);
        Log.e(TAG, this.virtualGrid.getRelatedPoints().size()+"  reDrawPointList");

        // 应该向后端提交数据点
        List <PointData> bindingStrokes = this.getBindingStrokes();


    }

    // 标注提交的笔迹
    @Override
    public void testMethod(View view) {
        DrawingView dw = (DrawingView) view;
        List <PointData> reDrawPointList = this.getBindingStrokes();
        submit(reDrawPointList);
        dw.notifyReDraw(reDrawPointList);
        dw.notifyTextChanged("点击提交按钮"+id+"!");

    }

    private static String TAG = "EventTriggerReceiver";

    public void submit(List<PointData> pointList){
        // 先进行坐标缩放，并且只拥有绘图所需属性
        List<PointSubmit> newPointList = new ArrayList<>();
        for (PointData pointData: pointList){
            newPointList.add(new PointSubmit(pointData));
        }
        // 存储题号和dp单位的笔迹信息
        StrokeSubmit strokes = new StrokeSubmit(id, newPointList);
        Gson gson = new Gson();
        String strokesString = gson.toJson(strokes);
        // TODO：do post request
        Log.e(TAG, "POST");
//        HttpUtils.post("url", strokesString, new Callback() {
//            @Override
//            public void onFailure(@NonNull Call call, @NonNull IOException e) {
//                // 失败逻辑
//            }
//
//            @Override
//            public void onResponse(@NonNull Call call, @NonNull Response response) throws IOException {
//                if(response.isSuccessful()){
//                    final String responseData = response.body().string();
//                    // 处理响应数据，可以更新主线程的UI
//                }
//            }
//        });
    }


}


// 向后端提交的数据点，需要进行缩放所以新建一个类
class PointSubmit{
    int x;
    int y;
    float line_width;
    boolean stroke_start;
    // 有个比较尴尬的问题，end的时候坐标位置基本是(0,0)，不会被绑定，导致end永远是false
    // 所以说end属性基本没用，需要判定轨迹结束只需要基于下一个点的start属性即可
    boolean stroke_end;
    double time_stamp;

    public PointSubmit(PointData pointData){
        this.x = (int) (pointData.get_x()* scalingFactor);
        this.y = (int) (pointData.get_y()* scalingFactor);
        this.line_width =pointData.getlinewidth();
        this.stroke_start = pointData.isStroke_start();
        this.stroke_end = pointData.isStroke_end();
        this.time_stamp = pointData.getTime_stamp();
    }

}

class StrokeSubmit{
    String id;
    List<PointSubmit> strokes;

    public StrokeSubmit(String id, List<PointSubmit> list){
        this.id = id;
        this.strokes = list;
    }

}