package com.example.bibipentest;

import android.Manifest;
import android.annotation.SuppressLint;
import android.bluetooth.BluetoothGatt;
import android.content.ComponentName;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.ServiceConnection;
import android.content.pm.ActivityInfo;
import android.content.pm.PackageManager;
import android.os.Bundle;
import android.os.Handler;
import android.os.IBinder;
import android.os.Looper;
import android.os.Message;
import android.util.Log;
import android.view.View;
import android.view.Window;
import android.view.WindowManager;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;


import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;

import com.bbb.bpen.binder.BiBiBinder;
import com.bbb.bpen.command.BiBiCommand;
import com.bbb.bpen.common.BBBType;
import com.bbb.bpen.delegate.BlueDelegate;
import com.bbb.bpen.model.Pen;
import com.bbb.bpen.model.PointData;
import com.bbb.bpen.service.BluetoothLEService;
import com.example.bibipentest.broadcast.EventTriggerReceiver;
import com.example.bibipentest.data.PointManager;
import com.example.bibipentest.view.DrawingView;

import java.util.ArrayList;
import java.util.List;


// TODO：该页废弃，以后会删除
public class MainActivity extends AppCompatActivity {

    static {
        System.loadLibrary("bbbdraw");
    }


    private static final int REQUEST_BLUETOOTH_PERMISSION = 111;
//    public static List<PointData> recies_data = new ArrayList<>();

//    public static List<PointData> store_data = new ArrayList<>();

    private static String TAG = "blueDelegate";

    public Boolean isBound;
    private BluetoothLEService service = null;

    private EventTriggerReceiver eventTriggerReceiver;

    Button btn1;
    Button btn2;

    Button btn3;

    // 上一个坐标点
    TextView textView1;
    TextView textView2;
    DrawingView dw;

    Toolbar toolbar;
    int firmversion;

    Handler updatehandler = new Handler();

    Runnable updaterunnable = new Runnable() {
        @Override
        public void run() {
//            ladapter.notifyDataSetChanged();
            Log.e(TAG, "notifyDataSetChanged called by updaterunnable");
        }
    };

    private ServiceConnection coon = new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName name, IBinder binder) {
            isBound = true;
            BiBiBinder myBinder = (BiBiBinder) binder;
            service = myBinder.getService();
            Log.e(TAG, "onServiceConnected "+isBound);
            service.setblueDelegate(blueDelegate);
            Log.e(TAG, "onServiceConnected "+isBound);
        }

        @Override
        public void onServiceDisconnected(ComponentName name) {
            Log.e(TAG, "onServiceDisconnected ");
            isBound = false;
        }
    };

    @SuppressLint({"MissingInflatedId", "ResourceType"})
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        setContentView(R.layout.activity_main);


        Intent intent = new Intent(this, BluetoothLEService.class);

        bindService(intent, coon, Context.BIND_AUTO_CREATE);

        System.loadLibrary("bbbdraw");

        // 锁定竖屏幕，禁止屏幕旋转
        setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);

        // init view
        btn1 = findViewById(R.id.btn1);
        btn2 = findViewById(R.id.btn2);
        btn3 = findViewById(R.id.permission);
        dw = findViewById(R.id.drawing);

        textView1 = findViewById(R.id.textView1);
        textView2 = findViewById(R.id.textView2);

        toolbar = findViewById(R.id.toolbar);
        setSupportActionBar(toolbar);
        getSupportActionBar().setTitle("答题");

        // 设置状态栏颜色和标题栏颜色相同
        Window window = getWindow();
        window.addFlags(WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS);
        window.setStatusBarColor(getResources().getColor(com.google.android.material.R.color.design_default_color_primary)); // 替换成你的颜色值

        btn1.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
//                try {
//                    Boolean bool = BiBiCommand.startScanWithQueue(MainActivity.this);
//                    Log.e(TAG, "startScanWithQueue "+bool);
//                }catch (Exception e){
//                    Log.e(TAG,  e.toString());
//                }
                // 清空布局
                dw.initDraw();

            }
        });

        btn2.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                // 更简单了，只需要将笔上MAC地址输入，转换一下强制连接即可
                String mac_address = "CFAF08A26A04";
//                String mac_address = "F6881FB43709";
                String mac_address_convert = Util.macConvert(mac_address);
                BiBiCommand.connect(MainActivity.this, mac_address_convert,true);
            }
        });

        btn3.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                checkBluetoothPermission();
            }
        });

        // 广播事件接收者用于触发点击事件
        eventTriggerReceiver = new EventTriggerReceiver(dw);
        IntentFilter intentFilter = new IntentFilter("CheckForEventTrigger");
        registerReceiver(eventTriggerReceiver, intentFilter);
    }

    ConnectionInterface callback = new ConnectionInterface() {
        @Override
        public void callback(String name, String mac) {
            select_name = name;
            select_mac = mac;
            Toast.makeText(MainActivity.this, "连接设备", Toast.LENGTH_LONG).show();
            BiBiCommand.connect(MainActivity.this, mac,false);// 非实时数据不自动删除
        }
    };

    // 判断是否连接
    private void checkBluetoothPermission() {
        // 检查蓝牙权限是否已授予
        // 写满权限
        if (ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH) != PackageManager.PERMISSION_GRANTED ||
                ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_ADMIN) != PackageManager.PERMISSION_GRANTED ||
                ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_CONNECT) != PackageManager.PERMISSION_GRANTED ||
                ContextCompat.checkSelfPermission(this, Manifest.permission.BLUETOOTH_SCAN) != PackageManager.PERMISSION_GRANTED ||
                ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED ||
                ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED

        ) {
            // 权限未被授予，需要申请权限
            Toast.makeText(MainActivity.this, "权限未被授予，需要申请权限", Toast.LENGTH_SHORT);
            ActivityCompat.requestPermissions(this, new String[]{
                    Manifest.permission.BLUETOOTH,
                    Manifest.permission.BLUETOOTH_ADMIN,
                    Manifest.permission.BLUETOOTH_CONNECT,
                    Manifest.permission.BLUETOOTH_SCAN,
                    Manifest.permission.ACCESS_FINE_LOCATION,
                    Manifest.permission.ACCESS_COARSE_LOCATION
            }, REQUEST_BLUETOOTH_PERMISSION);
        } else {
            // 权限已被授予，可以进行蓝牙操作
            Toast.makeText(MainActivity.this, "权限已被授予，可以进行蓝牙操作", Toast.LENGTH_SHORT);
        }
    }


    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);

        if (requestCode == REQUEST_BLUETOOTH_PERMISSION) {

            // 0表示授权成功，-1失败，全都为0即成功
            int grantResultsSum = 0;
            for (int grantResult: grantResults){
                grantResultsSum+=grantResult;
            }
            if (grantResults.length > 0 && grantResultsSum == PackageManager.PERMISSION_GRANTED) {
                // 权限已被授予，可以进行蓝牙操作
                Log.e(TAG, "权限已被授予，可以进行蓝牙操作");
                for (int i=0; i<grantResults.length; i++){
                    Log.e(TAG, "permission "+permissions[i] +":"+ grantResults[i]);
                }

            } else {
                // 权限被拒绝，无法执行蓝牙操作
                Log.e(TAG,"权限被拒绝，无法执行蓝牙操作");
                // 可以根据需要进行处理，例如显示一个提示信息或关闭应用程序
            }
        }
    }

    com.bbb.bpen.delegate.BlueDelegate blueDelegate = new BlueDelegate() {
        @Override
        public void didDiscoverWithPen(Pen device, int rssi) {
            String mac = device.getAddress();
            Log.e(TAG, "didDiscoverWithPen address " + device.getAddress() + "  " + rssi + "  " + device.getName());
//            if (addDevice(device)) {
//                Log.d("blueDelegate", "notifyDataSetChanged ");
//                ladapter.notifyDataSetChanged();
//            }
        }


        @Override
        public void didConnectFail(BluetoothGatt gatt, int status, int newState) {
//            Toast.makeText(MainActivity.this, "蓝牙断开 " + status + " " + newState, Toast.LENGTH_LONG).show();
            Log.e(TAG, "didDiscoverWithPen status " + status+" newState "+newState);

            updatehandler.postDelayed(updaterunnable, 10);
        }

        @Override
        public void didConnect(Pen device, int i, int i1) {
            Log.e("blueDelegate", "didConnect  connect " + BiBiCommand.isConnect(getApplicationContext()));

            Log.e("blueDelegate", "didConnect  智能笔蓝牙连接成功 " + BiBiCommand.getConnectedDevice());
            textView1.setText("连接状态：蓝牙笔连接成功");
            updatehandler.postDelayed(updaterunnable, 10);
        }

        @Override
        public void didDisconnect(Pen bluetoothDevice, int i, int i1) {
            Log.e("blueDelegate", "Disconnected连接断开  " + BiBiCommand.getConnectedDevice() + i + "  " + i1);
            firmversion = 0;
            devicedisconnect();
            updatehandler.postDelayed(updaterunnable, 10);
            textView1.setText("连接状态：蓝牙笔断开连接");
        }


        @Override
        public void notifyBattery(final int battery) {
            // 一直ping，消息太多了，给关掉
//            Log.e("blueDelegate", "notifyBattery 电量 " + battery);

            // TODO：电量显示
//            txt_pow.post(new Runnable() {
//                @Override
//                public void run() {
//                    txt_pow.setText("电量:" + battery + "");
//                }
//            });
//            Intent intent = new Intent(Constant.ACTION_RECIEVE_POW);
//            intent.putExtra("pow", battery);
//            sendBroadcast(intent);
        }



        // 绘图函数，应该只有这个起作用
        @SuppressLint("SetTextI18n")
        @Override
        public void notifyRealTimePointData(List<PointData> pointDrawArray) {

            // 添加数据，并通知绘图
            PointManager.getInstance().addPointToList(pointDrawArray);
            dw.notifyDraw();

            // 展示纸张信息，并触发初步判定
            if (pointDrawArray!=null && pointDrawArray.size()>0) {
                PointData endPoint = pointDrawArray.get(pointDrawArray.size() - 1);
                if(endPoint.isStroke_end()) {
//                    PointData lastPoint = PointManager.getInstance().getLatestPoint();
//                    List<PointData> lastStroke = PointManager.getInstance().getLatestStroke();
                    // 发送广播，提醒判定是否要触发相应的事件了
                    Intent intent = new Intent("CheckForEventTrigger");
                    sendBroadcast(intent);
                }
            }


            // 当且仅当最后一个点lw=0 end=true
//            Intent intent = new Intent(Constant.ACTION_RECIEVE_DBUFF);
//            sendBroadcast(intent);

        }

        @Override
        public void notifyBatchPointData(List<PointData> pointDrawArray) {
//            Log.e("blueDelegate", "datanotifyBatchPointData ");
//            for (int i = 0; i < pointDrawArray.size(); i++) {
//
////                recies_data.add(pointDrawArray.get(i));
//                PointData penPoint = pointDrawArray.get(i);
//                PointManager.getInstance().addPointToList(penPoint);
//            }

//            Intent intent = new Intent(Constant.ACTION_RECIEVE_DBUFF);
//            sendBroadcast(intent);
        }

        @Override
        public void notifyFirmwareWithNewVersion(String newVersion) {

            String versionstr = newVersion.substring(newVersion.lastIndexOf("-") + 1);
            firmversion = Util.getIntByStr(versionstr);
//            viewupdate(R.id.txt_gujian, "固件版本:" + newVersion);
//
//            BiBiCommand.cameraControl(ScanActivity.this, 1);
//            String firmversion = "ADD IT";
            Log.e("blueDelegate ", "notifyFirmwareWithNewVersion 固件版本号  " + newVersion + "  " + firmversion);
        }


        @Override
        public void unsynchronizedDataWithPercentage(float percentage) {
            Log.e("blueDelegate ", "unsynchronizedDataWithPercentage 已使用 百分之  " + percentage + "  ");
//            showToast("已使用  " + percentage + "%");
        }


        @Override
        public void notifySyncComplete() {
            Log.d("blueDelegatecc ", "同步完成 ");
        }

        @Override
        public void notifyDataSynchronizationMode(int mode) {
            // 可能是在线传输和离线传输模式吧
            Log.e("blueDelegatecc ", "notifyDataSynchronizationMode mode " + mode);
//            if(mode == 0){
//                rbtn_realtime.setChecked(true);
//                rbtn_batchtime.setChecked(false);
//            }else{
//                rbtn_realtime.setChecked(false);
//                rbtn_batchtime.setChecked(true);
//            }
        }

        @Override
        public void notifyContinueToUseSuccess() {
            Log.e("disconnect ", "notifyContinueToUseSuccess ");
            updatehandler.postDelayed(updaterunnable, 10);
            deviceconnect();
        }

        @Override
        public void notifyContinueToUseFail() {
            Log.e("disconnect ", "notifyContinueToUseFail ");
            BiBiCommand.disconnect(MainActivity.this);
        }

        @Override
        public void notifyBoundMobile(String mobile) {
            Log.e("disconnect ", "notifyBoundMobile 连接失败  笔已经被尾号是 " + mobile + "手机号绑定了。");
            Looper.prepare();
            Toast.makeText(MainActivity.this, "连接失败，笔已经被尾号是" + mobile + "的手机绑定了。"
                    , Toast.LENGTH_LONG).show();
            Looper.loop();
            BiBiCommand.disconnect(MainActivity.this);
        }

        @Override
        public void accelerometerDataSendFromPenOnXYZ(float x, float y, float z, int jiaodu) {
            Log.e("accelerometer", "accelerometer加速度 x=" + x + " y=" + y + " z=" + z + " 角度=" + jiaodu);

        }

        @Override
        public void notifyWrittingBatchPointData(List<PointData> pointDrawArray) {
            Log.e("blueDelegate", "notifyWrittingBatchPointData ");
        }

        @Override
        public void notifyOfflineBatchPointData(List<PointData> pointDrawArray,int remainpackage) {
            Log.e("blueDelegate", "剩余包数 " + remainpackage);
        }

        @Override
        public void notifyCameraState() {
            Log.e("blueDelegate ", "notifyCameraState  摄像头被遮挡 ");
            showToast("摄像头被遮挡");
        }

        @Override
        public void notifyChargeState(int chargestatus) {

            Log.e("disconnect ", "notifyChargeState " + chargestatus);

            if(chargestatus == BBBType.CHARGESTATUS_INCHARGING){
                showToast("充电中");
            }else if(chargestatus == BBBType.CHARGESTATUS_FULLPOWER){
                showToast("电量已经充满");
            }else  {
                showToast("未充电");
            }

        }

        @Override
        public void notifyModel(String model) {
            Log.e("disconnect ", "notifyModel  型号 " + model);
        }

    };

    public void showToast(String msg) {
        Message message = Message.obtain();
        message.what = 0;
        Bundle bundle = new Bundle();
        bundle.putString("msg", msg);
        message.setData(bundle);
        toasthandler.sendMessage(message);
    }

    Handler devicedisconnecthandler = new Handler();
    public void devicedisconnect() {
        devicedisconnecthandler.post(devicedisconnectrunnable);
    }

    Runnable devicedisconnectrunnable = new Runnable() {
        @Override
        public void run() {
            Log.e("blueDelegate", "未连接智能笔");
//            title_text.setText("未连接智能笔");
//            title_flash.setTextColor(ScanActivity.this.getResources().getColor(R.color.text_grey));
//            title_draw.setTextColor(ScanActivity.this.getResources().getColor(R.color.text_grey));
//            title_discon.setTextColor(ScanActivity.this.getResources().getColor(R.color.text_grey));
        }
    };

    String select_name = "";
    String select_mac = "";

    Handler deviceconnecthandler = new Handler();
    Runnable deviceconnectrunnable = new Runnable() {
        @Override
        public void run() {
            Log.e("blueDelegate", "deviceconnectrunnable:已连接智能笔"+select_name+"mac"+select_mac);
//            title_text.setText("已连接智能笔:name:" + select_name + "mac" + select_mac);
//            title_flash.setTextColor(ScanActivity.this.getResources().getColor(R.color.blue));
//            title_draw.setTextColor(ScanActivity.this.getResources().getColor(R.color.blue));
//            title_discon.setTextColor(ScanActivity.this.getResources().getColor(R.color.blue));
        }
    };

    public void deviceconnect() {
        deviceconnecthandler.post(deviceconnectrunnable);
    }

    @SuppressLint("HandlerLeak")
    Handler toasthandler = new Handler() {

        @Override
        public void handleMessage(Message msg) {
            switch (msg.what) {
                case 0:
                    Bundle bundle = msg.getData();
                    if (bundle != null) {
                        Toast.makeText(MainActivity.this, bundle.getString("msg", ""), Toast.LENGTH_LONG).show();
                    }
                    break;
                default:
                    break;
            }
        }
    };

    @Override
    protected void onDestroy() {
        super.onDestroy();
        // 取消广播
        unregisterReceiver(eventTriggerReceiver);
    }
}